
<div class="page-header">
	<h1>Articles found: <em id="articles_count">Loading...</em>
		
		<button id="order_by_relevance_button" type="button" class="btn btn-default pull-right disabled" data-toggle="tooltip" data-placement="top" title="Order by relevance" style="margin-top: 3px;">
			<span class="glyphicon glyphicon-chevron-up"></span>
		</button>
	</h1>
</div>

<div class="row">
	<div class="col-md-11">
		<div class="progress progress-striped active" style="margin-top: 10px; margin-bottom: 10px;">
			<div id="articles_progress-bar" class="progress-bar progress-bar-warning"  role="progressbar" aria-valuenow="45" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
				<span class="sr-only">0% Complete</span>
		  	</div>
		</div>
	</div>
	<div class="col-md-1">
		<button id="kill_diffbot_request_button" type="button" class="btn btn-default pull-right" data-toggle="tooltip" data-placement="top" title="Stop" style="margin-top: 3px;">
			<span class="glyphicon glyphicon-remove"></span>
		</button>
	</div>	
</div>

<div id="articles_list"></div>

<script>
var short_urls = <%= raw @short_urls %>;
var short_urls_count = short_urls.length;
var short_urls_map = {};
var articles_count = 0;
var url;
var kill_diffbot_request = false;

$(document).ready(function() {
	$('.btn').tooltip();
	$("#kill_diffbot_request_button").click(function() {
  		kill_diffbot_request = true;
  		$("#kill_diffbot_request_button").addClass( "disabled" );
	});
	$("#order_by_relevance_button").click(function() {
  		order_articles_by_relevance();
  		$("#order_by_relevance_button").addClass( "disabled" );
	});
	display_articles();
});


function display_articles(){
	if (articles_are_processed) {
		$("#kill_diffbot_request_button").addClass( "disabled" );
		$("#order_by_relevance_button").removeClass( "disabled" );
		for(var k in articles) {
			display_article(articles[k]["data"]);
		}
		update_progress_bar(short_urls_count, processed_articles);
	}
	else {
		process_articles(0);
	}
}

function process_articles(i){
	
	processed_articles = i;
	update_progress_bar(short_urls_count, processed_articles);
	
	if ((kill_diffbot_request) || (i >= short_urls_count)) { 
		if (kill_diffbot_request) {console.log("REQUEST ABORDED !");}
		else {
			$('#articles_progress-bar').attr('class', 'progress-bar progress-bar-success');
			$('#articles_progress-bar').parent().removeClass("active");
		}
		console.log("ARTICLES: ");
		console.log(articles);
		articles_are_processed = true;
		if (store_in_db) $.post('/diffbot_api/create', {url: "research", response: JSON.stringify(articles)});
		$("#kill_diffbot_request_button").addClass( "disabled" );
		$("#order_by_relevance_button").removeClass( "disabled" );
		return ;
	}

	url = short_urls[i]; // we retrieve the short url
	if (url in short_urls_map) { //if the short url has already been processed
		console.log(url + " is already in.");
		articles[short_urls_map[url]]["count"] += 1; //we add a count to the article list
		process_articles(i+1);
	} else { //we process the ajax request to DIffbot API 
		ajax_request(i);
	}	
}

function ajax_request(i){
	$.ajax({
		url: "http://api.diffbot.com/v2/article",
		context: document.body,
		data: { token : "eecf536c1f7d84030c6eabea9ad4e134", url: url }
	})
	.done(function(article) {
		found_url = article["resolved_url"] || url ;
		short_urls_map[url] = found_url ;

		if (found_url in articles) {
			console.log(found_url + ' is already in');
			articles[found_url]["count"] += 1;
		}
		else {
			console.log("new article: " + found_url);
			articles[found_url] = { count: 1, data: article};
			
			display_article(article); // we display the article
		}
		process_articles(i+1);
	});
}

function display_article(article){
	
	var template ='<hr ><div class="media">';
	template	+='<a class="pull-left" href="' + article["resolved_url"]+'", target="_blank"">'
  				+ '<img class="media-object" data-src="holder.js/64x64" alt="64x64" src="';
  	
  	if (typeof article["images"] === "undefined" || article["images"].length == 0) {
    	template +='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NCIgaGVpZ2h0PSI2NCI+PHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiBmaWxsPSIjZWVlIj48L3JlY3Q+PHRleHQgdGV4dC1hbmNob3I9Im1pZGRsZSIgeD0iMzIiIHk9IjMyIiBzdHlsZT0iZmlsbDojYWFhO2ZvbnQtd2VpZ2h0OmJvbGQ7Zm9udC1zaXplOjEycHg7Zm9udC1mYW1pbHk6QXJpYWwsSGVsdmV0aWNhLHNhbnMtc2VyaWY7ZG9taW5hbnQtYmFzZWxpbmU6Y2VudHJhbCI+NjR4NjQ8L3RleHQ+PC9zdmc+';
    } else {
    	template += article["images"][0]["url"];
    }
	
  	template	+='" style="width: 64px; height: 64px;">'
  				+ '</a>'
  			 	+ '<div class="media-body">'
  			 	+ '<a href="' + article["resolved_url"]+'", target="_blank"">'
  			 	+ '<h4 class="media-heading">'+ article["title"] +'</h4>'
    		 	+ '</a>'
    		 	+ '<em> Posted on '+ article["date"] + ', by ' + article["author"] + ' </em>';
    if (typeof article["text"] === "undefined") {
    	template += '<p>No summary available...</p>';
    } else {
    	template +='<p>' + article["text"].substring(0,500); + '</p>';
    }		
    template += '</div></div>';
    
    articles_count += 1;
    $("#articles_list").append(template);
	$('#articles_count').html(articles_count);
}

function update_progress_bar(size, i){
	var valeur = 100;
	if (size != 0) { valeur = i * 100 / size; } 
	
	$('#articles_progress-bar').css('width', valeur+'%').attr('aria-valuenow', valeur);	
}

function order_articles_by_relevance(){
	$('#articles_list').html("");
	articles_count = 0;
	
	var sorted_articles = [];
    for (var k in articles) sorted_articles.push([articles[k]["count"], articles[k]["data"]]);

    sorted_articles.sort(function(a, b) { return a[0] < b[0] ? 1 : a[0] > b[0] ? -1 : 0 });
	
	for(var k in sorted_articles) {
		display_article(sorted_articles[k][1]);
	}
}
</script>
